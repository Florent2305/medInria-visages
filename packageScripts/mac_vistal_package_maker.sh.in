#!/bin/bash

\rm -fr @CMAKE_INSTALL_PREFIX@/PackageRootDir
mkdir -p @CMAKE_INSTALL_PREFIX@/PackageRootDir/Applications/medInria.app/Contents/{Frameworks,PlugIns}

mkdir -p @CMAKE_INSTALL_PREFIX@/PackageRootDir/Applications/medInria.app/Contents/Frameworks/Vistal

cp @CMAKE_INSTALL_PREFIX@/plugins/libvistal* @CMAKE_INSTALL_PREFIX@/PackageRootDir/Applications/medInria.app/Contents/PlugIns/

for f in @CMAKE_INSTALL_PREFIX@/PackageRootDir/Applications/medInria.app/Contents/PlugIns/libvistal*.dylib
do
	# ITK, DTK and MED stuff (already installed)
	for libname in `otool -L $f | grep -i -e 'med|dtk|itk' | awk '{print $1;}'`
	do
		install_name_tool -change $libname @executable_path/../Frameworks/`basename $libname` $f
	done
	
	#Qt stuff (already installed)
	for libname in `otool -L $f | grep .framework | awk '{print $1;}'`
	do
		install_name_tool -change $libname @executable_path/../Frameworks/$libname $f
	done
	
	# Vistal stuff
	for libname in `otool -L $f | grep @Vistal_DIR@ | awk '{print $1;}'`
	do
		baselibname=`basename $libname`
		cp $libname @CMAKE_INSTALL_PREFIX@/PackageRootDir/Applications/medInria.app/Contents/Frameworks/Vistal/
		install_name_tool -change $libname @executable_path/../Frameworks/Vistal/$baselibname $f
	done
done

for f in @CMAKE_INSTALL_PREFIX@/PackageRootDir/Applications/medInria.app/Contents/Frameworks/Vistal/*.dylib
do
	for libname in `otool -L $f | grep @Vistal_DIR@ | awk '{print $1;}'`
	do
		baselibname=`basename $libname`
		if [ ! -e $baselibname ]; then
			cp $libname @CMAKE_INSTALL_PREFIX@/PackageRootDir/Applications/medInria.app/Contents/Frameworks/Vistal/
		fi
		
		install_name_tool -change $libname @executable_path/../Frameworks/Vistal/$baselibname $f
	done
done

sudo chown -R root:admin @CMAKE_INSTALL_PREFIX@/PackageRootDir
sudo chmod -R g+w @CMAKE_INSTALL_PREFIX@/PackageRootDir

/Developer/usr/bin/packagemaker --title "Vistal Plugins" --version 1.0 --filter "\.DS_Store" --root-volume-only --domain system --verbose --no-relocate --target 10.5 --id com.medInria.vistal_installer.pkg --root @CMAKE_INSTALL_PREFIX@/PackageRootDir --out @CMAKE_INSTALL_PREFIX@/VistalPluginsInstaller.pkg
