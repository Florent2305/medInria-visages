#!/bin/bash

\rm -fr @CMAKE_INSTALL_PREFIX@/PackageRootDir
mkdir -p @CMAKE_INSTALL_PREFIX@/PackageRootDir/Applications/medInria.app/Contents/{Frameworks,PlugIns}

cd @CMAKE_INSTALL_PREFIX@/PackageRootDir/Applications/medInria.app/Contents

mkdir -p Frameworks/Vistal Frameworks/Dcm Frameworks/DCMTK Frameworks/Shanoir

cp @CMAKE_BINARY_DIR@/plugins/libvistal* PlugIns/
cp @CMAKE_BINARY_DIR@/plugins/libqtshanoir* PlugIns/

for i in $( otool -L PlugIns/*.dylib 2> /dev/null \
| sort -u | grep -i -E '@medInria_DIR@|@dtk_DIR@|itk|vtk' | cut -d " " -f 1 ); do
	cp -np $i Frameworks/ 2> /dev/null;
done

for i in $( otool -L Frameworks/* 2> /dev/null \
| sort -u | grep -i -E '@medInria_DIR@|@dtk_DIR@|itk|vtk' | cut -d " " -f 1 ); do
	cp -np $i Frameworks 2> /dev/null;
done


for f in PlugIns/*.dylib
do
	install_name_tool -id @executable_path/../$f $f
	
	# ITK, VTK stuff
	for libname in `otool -L $f | sed "1d" | grep -i -E '@medInria_DIR@|@dtk_DIR@|itk|vtk' | cut -d " " -f 1`
	do
		install_name_tool -change $libname @executable_path/../Frameworks/`basename $libname` $f
	done
	
	for libname in `otool -L $f | sed "1d" | grep boost | cut -d " " -f 1`
	do
		if [ ! -e Frameworks/$libname ]; then
			\cp -np @Boost_LIBRARY_DIRS@/`basename $libname` Frameworks/
		fi
		install_name_tool -change $libname @executable_path/../Frameworks/`basename $libname` $f
	done
	
	#Qt stuff (should hopefully be there already)
	for j in $( otool -L $f | sed "1d" | grep -E .framework | grep -i -E 'Qt|phonon' | cut -d " " -f 1 ); do
		#Depending on Qt SDK, paths may be relative or not
		tmpVal=`echo $j | rev | cut -d "/" -f 1-4 | rev`
		if [ "`echo $j | grep executable_path`" == "" ]; then
			install_name_tool -change $j @executable_path/../Frameworks/$tmpVal $f
		fi
	done
done

for f in PlugIns/libvistal*.dylib
do
	for libname in `otool -L $f | sed "1d" | grep @Vistal_DIR@ | cut -d " " -f 1`
	do
		baselibname=`basename $libname`
		cp $libname Frameworks/Vistal/
		install_name_tool -change $libname @executable_path/../Frameworks/Vistal/$baselibname $f
	done
done

for f in PlugIns/libqtshanoir*.dylib
do
	for libname in `otool -L $f | sed "1d" | grep @QTSHANOIR_DIR@ | cut -d " " -f 1`
	do
		baselibname=`basename $libname`
		cp $libname Frameworks/Shanoir/
		install_name_tool -change $libname @executable_path/../Frameworks/Shanoir/$baselibname $f
	done
done

for f in Frameworks/Vistal/*.dylib
do
	install_name_tool -id @executable_path/../$f $f
	
	for libname in `otool -L $f | sed "1d" | grep @Vistal_DIR@ | cut -d " " -f 1`
	do
		baselibname=`basename $libname`
		if [ ! -e Frameworks/Vistal/$baselibname ]; then
			cp $libname Frameworks/Vistal/
		fi
		
		install_name_tool -change $libname @executable_path/../Frameworks/Vistal/$baselibname $f
	done
done

#Shanoir has subdependencies that depend on Qt, needs a double run
for ((i=1;i<=2;i++))
do
	for f in Frameworks/Shanoir/*.dylib
	do
		install_name_tool -id @executable_path/../$f $f

		#Qt stuff (should hopefully be there already)
		for j in $( otool -L $f | sed "1d" | grep -E .framework | grep -i -E 'Qt|phonon' | cut -d " " -f 1 ); do
			#Depending on Qt SDK, paths may be relative or not
			tmpVal=`echo $j | rev | cut -d "/" -f 1-4 | rev`
			if [ "`echo $j | grep executable_path`" == "" ]; then
				install_name_tool -change $j @executable_path/../Frameworks/$tmpVal $f
			fi
    	done
    
    	for libname in `otool -L $f | sed "1d" | grep @QTSHANOIR_DIR@ | cut -d " " -f 1`
    	do
    		baselibname=`basename $libname`
    		if [ ! -e Frameworks/Shanoir/$baselibname ]; then
				cp $libname Frameworks/Shanoir/
			fi
		
			install_name_tool -change $libname @executable_path/../Frameworks/Shanoir/$baselibname $f
		done
	done
done

#dtk has subdependencies that depend on Qt, needs a double run
for ((i=1;i<=2;i++))
do
	for f in Frameworks/*.dylib
	do
		install_name_tool -id @executable_path/../$f $f

		for libname in `otool -L $f | sed "1d" | grep -i -E '@medInria_DIR@|@dtk_DIR@|itk|vtk' | cut -d " " -f 1`
		do
			baselibname=`basename $libname`
		
			if [ ! -e Frameworks/$baselibname ]; then
				cp $libname Frameworks/
			fi
		
			if [ "`echo $libname | grep @executable_path`" = "" ]; then
				install_name_tool -change $libname @executable_path/../Frameworks/$baselibname $f
			fi
		done
	
		#Qt stuff (should hopefully be there already)
		for j in $( otool -L $f | sed "1d" | grep -E .framework | grep -i -E 'Qt|phonon' | cut -d " " -f 1 ); do
			#Depending on Qt SDK, paths may be relative or not
			tmpVal=`echo $j | rev | cut -d "/" -f 1-4 | rev`
			if [ "`echo $j | grep executable_path`" == "" ]; then
				install_name_tool -change $j @executable_path/../Frameworks/$tmpVal $f
			fi
    	done
	done
done

echo @CMAKE_INSTALL_PREFIX@/PackageRootDir
