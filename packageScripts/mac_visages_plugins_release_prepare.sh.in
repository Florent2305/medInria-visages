#!/bin/bash

\rm -fr @CMAKE_INSTALL_PREFIX@/PackageRootDir
mkdir -p @CMAKE_INSTALL_PREFIX@/PackageRootDir/Applications/medinria.app/Contents/{Frameworks,PlugIns}

# Starting VISTAL stuff
mkdir -p @CMAKE_INSTALL_PREFIX@/PackageRootDir/Applications/medinria.app/Contents/Frameworks/Vistal

cd @CMAKE_INSTALL_PREFIX@/PackageRootDir/Applications/medinria.app/Contents

cp @CMAKE_INSTALL_PREFIX@/plugins/libvistal* PlugIns/

for f in PlugIns/libvistal*.dylib
do
	install_name_tool -id @executable_path/../$f $f
	
	# ITK, VTK stuff
	for libname in `otool -L $f | sed "1d" | grep -i -E 'itk|vtk' | cut -d " " -f 1`
	do
		if [ ! -e Frameworks/`basename $libname` ]; then
			cp $libname Frameworks/
		fi
		
		install_name_tool -change $libname @executable_path/../Frameworks/`basename $libname` $f
	done
	
	# DTK and MED stuff is already installed
	for libname in `otool -L $f | sed "1d" | grep -i -E '@medinria_DIR@|@dtk_DIR@' | cut -d " " -f 1`
	do		
		install_name_tool -change $libname @executable_path/../Frameworks/`basename $libname` $f
	done

	#Qt stuff (should hopefully be there already)
	for j in $( otool -L $f | sed "1d" | grep -E @QT_LIBRARY_DIR@ | cut -d " " -f 1 ); do
		#Depending on Qt SDK, paths may be relative or not
		tmpVal=`echo $j | rev | cut -d "/" -f 1-4 | rev`
		install_name_tool -change $j @executable_path/../Frameworks/$tmpVal $f
    done

	# Vistal stuff
	for libname in `otool -L $f | sed "1d" | grep @Vistal_DIR@ | cut -d " " -f 1`
	do
		baselibname=`basename $libname`
		cp $libname Frameworks/Vistal/
		install_name_tool -change $libname @executable_path/../Frameworks/Vistal/$baselibname $f
	done
done

# Starting QtDcm stuff

mkdir -p Frameworks/Dcm Frameworks/DCMTK

cp @CMAKE_INSTALL_PREFIX@/plugins/libqtdcm* PlugIns/

for f in PlugIns/libqtdcm*.dylib
do
	install_name_tool -id @executable_path/../$f $f

	# ITK, VTK stuff
	for libname in `otool -L $f | sed "1d" | grep -i -E 'itk|vtk' | cut -d " " -f 1`
	do
		if [ ! -e Frameworks/`basename $libname` ]; then
			cp $libname Frameworks/
		fi
		
		install_name_tool -change $libname @executable_path/../Frameworks/`basename $libname` $f
	done
	
	# DTK and MED stuff is already installed
	for libname in `otool -L $f | sed "1d" | grep -i -E '@medinria_DIR@|@dtk_DIR@' | cut -d " " -f 1`
	do		
		install_name_tool -change $libname @executable_path/../Frameworks/`basename $libname` $f
	done
	
	#Qt stuff (should hopefully be there already)
	for j in $( otool -L $f | sed "1d" | grep -E @QT_LIBRARY_DIR@ | cut -d " " -f 1 ); do
		#Depending on Qt SDK, paths may be relative or not
		tmpVal=`echo $j | rev | cut -d "/" -f 1-4 | rev`
		install_name_tool -change $j @executable_path/../Frameworks/$tmpVal $f
    done

	# QtDcm lib
	for libname in `otool -L $f | sed "1d" | grep @QTDCM_DIR@ | cut -d " " -f 1`
	do
		baselibname=`basename $libname`
		cp $libname Frameworks/Dcm/
		install_name_tool -change $libname @executable_path/../Frameworks/Dcm/$baselibname $f
	done
done

for f in Frameworks/Vistal/*.dylib
do
	install_name_tool -id @executable_path/../$f $f
	
	for libname in `otool -L $f | sed "1d" | grep @Vistal_DIR@ | cut -d " " -f 1`
	do
		baselibname=`basename $libname`
		if [ ! -e Frameworks/Vistal/$baselibname ]; then
			echo Not cool $baselibname is not treated
			cp $libname Frameworks/Vistal/
		fi
		
		install_name_tool -change $libname @executable_path/../Frameworks/Vistal/$baselibname $f
	done
done

for f in Frameworks/Dcm/*.dylib
do
	install_name_tool -id @executable_path/../$f $f

	# ITK stuff (already installed)
	for libname in `otool -L $f | sed "1d" | grep -i -E 'itk' | cut -d " " -f 1`
	do
		if [ ! -e Frameworks/`basename $libname` ]; then
			cp $libname Frameworks
		fi

		install_name_tool -change $libname @executable_path/../Frameworks/`basename $libname` $f
	done
	
	#Qt stuff (should hopefully be there already)
	for j in $( otool -L $f | sed "1d" | grep -E @QT_LIBRARY_DIR@ | cut -d " " -f 1 ); do
		#Depending on Qt SDK, paths may be relative or not
		tmpVal=`echo $j | rev | cut -d "/" -f 1-4 | rev`
		install_name_tool -change $j @executable_path/../Frameworks/$tmpVal $f
    done
    
    for libname in `otool -L $f | sed "1d" | grep dcmtk | cut -d " " -f 1`
    do
    	baselibname=`basename $libname`
    	if [ ! -e Frameworks/DCMTK/$baselibname ]; then
			cp $libname Frameworks/DCMTK/
		fi
		
		install_name_tool -change $libname @executable_path/../Frameworks/DCMTK/$baselibname $f
	done
done

for f in Frameworks/DCMTK/*.dylib
do
	install_name_tool -id @executable_path/../$f $f

	for libname in `otool -L $f | sed "1d" | grep dcmtk | cut -d " " -f 1`
	do
		baselibname=`basename $libname`
		if [ ! -e Frameworks/DCMTK/$baselibname ]; then
			echo Not cool $baselibname is not treated
			cp $libname Frameworks/DCMTK/
		fi
		
		install_name_tool -change $libname @executable_path/../Frameworks/DCMTK/$baselibname $f
	done
done

for f in Frameworks/*.dylib
do
	install_name_tool -id @executable_path/../$f $f

	for libname in `otool -L $f | sed "1d" | grep -i -E 'itk|vtk' | cut -d " " -f 1`
	do
		baselibname=`basename $libname`
		
		if [ ! -e Frameworks/$baselibname ]; then
			echo $baselibname `basename $f`
			cp $libname Frameworks/
		fi
		
		install_name_tool -change $libname @executable_path/../Frameworks/$baselibname $f
	done
done

